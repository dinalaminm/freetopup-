<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Add Money - FREE TOPUP PRO</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f0f5ff; }
        [v-cloak] { display: none !important; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; font-weight: 500; color: #64748b; text-decoration: none; }
        .nav-item i { font-size: 18px; margin-bottom: 4px; }
        .nav-item.active { color: #583cb3; font-weight: 700; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .pop-enter-active { transition: all 0.3s ease-out; }
        .pop-leave-active { transition: all 0.2s ease-in; }
        .pop-enter-from, .pop-leave-to { opacity: 0; transform: scale(0.9); }
    </style>
</head>
<body class="bg-[#f0f5ff]">

    <div id="app" v-cloak class="max-w-md mx-auto min-h-screen relative flex flex-col">
        
        <!-- POPUP -->
        <transition name="pop">
            <div v-if="popup.show" class="fixed inset-0 z-[100] flex items-center justify-center px-6">
                <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" @click="closePopup"></div>
                <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm relative z-10 text-center transform transition-all">
                    <div v-if="popup.type === 'success'" class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-green-500">
                        <i class="fa-solid fa-check text-3xl"></i>
                    </div>
                    <div v-else class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500">
                        <i class="fa-solid fa-triangle-exclamation text-3xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">{{ popup.title }}</h3>
                    <p class="text-sm text-gray-500 mb-6 leading-relaxed">{{ popup.msg }}</p>
                    <button @click="closePopup" :class="popup.type === 'success' ? 'bg-green-500' : 'bg-red-500'" class="w-full text-white py-3 rounded-xl font-bold transition shadow-lg">{{ popup.btnText }}</button>
                </div>
            </div>
        </transition>

        <!-- HEADER -->
        <header class="bg-white shadow-sm border-b p-3 flex items-center sticky top-0 z-50">
            <a v-if="step === 1" href="index.html" class="mr-3 text-gray-600"><i class="fa-solid fa-arrow-left text-lg"></i></a>
            <button v-else @click="step--" class="mr-3 text-gray-600"><i class="fa-solid fa-arrow-left text-lg"></i></button>
            <h1 class="font-bold text-lg text-gray-800">Add Money</h1>
        </header>

        <!-- MAIN CONTENT -->
        <main class="flex-grow p-4 pb-24">
            
            <!-- STEP 1: AMOUNT -->
            <transition name="fade">
                <div v-if="step === 1" class="flex flex-col h-full justify-center">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                        <div class="text-center mb-6">
                            <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3 text-purple-600">
                                <i class="fa-solid fa-wallet text-3xl"></i>
                            </div>
                            <h2 class="text-xl font-bold text-gray-800">Recharge Balance</h2>
                            <p class="text-xs text-gray-500 mt-1">Instant Auto Deposit System</p>
                        </div>
                        <label class="block text-sm font-bold text-gray-600 mb-2">Enter Amount</label>
                        <div class="relative mb-6">
                            <span class="absolute left-4 top-3.5 text-gray-500 font-bold">৳</span>
                            <input v-model="amount" type="number" placeholder="0" class="w-full border border-gray-300 py-3 pl-8 pr-4 rounded-xl text-lg font-bold outline-none focus:border-purple-500 transition">
                        </div>
                        <div class="grid grid-cols-4 gap-2 mb-6">
                            <button @click="amount = 100" class="border rounded-lg py-1 text-xs font-bold hover:bg-purple-50">100</button>
                            <button @click="amount = 300" class="border rounded-lg py-1 text-xs font-bold hover:bg-purple-50">300</button>
                            <button @click="amount = 500" class="border rounded-lg py-1 text-xs font-bold hover:bg-purple-50">500</button>
                            <button @click="amount = 1000" class="border rounded-lg py-1 text-xs font-bold hover:bg-purple-50">1000</button>
                        </div>
                        <button @click="goToMethod" class="w-full bg-[#583cb3] text-white py-3.5 rounded-xl font-bold shadow-lg hover:bg-purple-700 transition flex justify-center items-center gap-2">Next Step <i class="fa-solid fa-arrow-right"></i></button>
                    </div>
                </div>
            </transition>

            <!-- STEP 2: METHOD -->
            <transition name="fade">
                <div v-if="step === 2">
                    <h2 class="font-bold text-gray-700 mb-4">Select Payment Method</h2>
                    <div class="space-y-3">
                        <div @click="selectMethod('bkash')" class="bg-white p-4 rounded-xl border border-gray-200 flex items-center justify-between cursor-pointer hover:border-pink-500 shadow-sm transition">
                            <div class="flex items-center gap-4">
                                <img src="https://seeklogo.com/images/B/bkash-logo-FBB258B90F-seeklogo.com.png" class="w-10">
                                <span class="font-bold text-gray-700">bKash</span>
                            </div>
                            <i class="fa-solid fa-chevron-right text-gray-400"></i>
                        </div>
                        <div @click="selectMethod('nagad')" class="bg-white p-4 rounded-xl border border-gray-200 flex items-center justify-between cursor-pointer hover:border-orange-500 shadow-sm transition">
                            <div class="flex items-center gap-4">
                                <img src="https://seeklogo.com/images/N/nagad-logo-7A70CCFEE0-seeklogo.com.png" class="w-10">
                                <span class="font-bold text-gray-700">Nagad</span>
                            </div>
                            <i class="fa-solid fa-chevron-right text-gray-400"></i>
                        </div>
                        <div @click="selectMethod('rocket')" class="bg-white p-4 rounded-xl border border-gray-200 flex items-center justify-between cursor-pointer hover:border-purple-500 shadow-sm transition">
                            <div class="flex items-center gap-4">
                                <img src="https://seeklogo.com/images/D/dutch-bangla-rocket-logo-B4D1CC458D-seeklogo.com.png" class="w-10">
                                <span class="font-bold text-gray-700">Rocket</span>
                            </div>
                            <i class="fa-solid fa-chevron-right text-gray-400"></i>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- STEP 3: GATEWAY -->
            <transition name="fade">
                <div v-if="step === 3" class="h-full">
                    <div :class="gatewayColor" class="rounded-t-2xl p-4 text-white flex items-center justify-between shadow-md transition-colors duration-300">
                        <div class="flex items-center gap-3">
                            <div class="bg-white p-1 rounded shadow-sm">
                                <img :src="methodLogo" class="w-8 h-8 object-contain">
                            </div>
                            <div>
                                <h3 class="font-bold text-sm">Merchant Pay</h3>
                                <p class="text-[10px] opacity-90">Secure Payment</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px]">Amount</p>
                            <p class="font-bold text-lg">৳ {{ amount }}</p>
                        </div>
                    </div>

                    <div class="bg-white p-5 rounded-b-2xl shadow-sm border-x border-b border-gray-200">
                        <div class="mb-6 text-center">
                            <p class="text-xs text-gray-500 mb-1">Send Money To (Personal)</p>
                            <div class="flex items-center justify-center gap-2 bg-gray-50 p-2 rounded-lg border border-dashed border-gray-300">
                                <span class="font-mono font-bold text-lg text-gray-800 tracking-wide select-all">{{ adminNumber }}</span>
                                <button @click="copyNumber" class="text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300 font-bold active:scale-90 transition"><i class="fa-regular fa-copy"></i></button>
                            </div>
                        </div>

                        <div class="text-[10px] text-gray-500 mb-6 bg-yellow-50 p-2 rounded border border-yellow-100">
                            <i class="fa-solid fa-circle-info text-yellow-600"></i> 
                            আপনার {{ method }} অ্যাপ থেকে উপরের নাম্বারে <b>Send Money</b> করুন। এরপর নিচের বক্সে TrxID দিন।
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">Account Number (Sender)</label>
                                <input v-model="senderNumber" type="tel" placeholder="017xxxxxxxx" class="w-full border border-gray-300 p-3 rounded-lg text-sm outline-none focus:border-gray-400 transition bg-gray-50 focus:bg-white">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">Transaction ID (TrxID)</label>
                                <input v-model="trxId" type="text" placeholder="e.g. 9H7G6..." class="w-full border border-gray-300 p-3 rounded-lg text-sm outline-none focus:border-gray-400 transition uppercase bg-gray-50 font-mono focus:bg-white">
                            </div>
                        </div>

                        <button @click="submitPayment" :disabled="loading" :class="gatewayButtonColor" class="w-full text-white py-3 rounded-lg font-bold shadow-lg mt-8 transition flex justify-center items-center gap-2 active:scale-95">
                            <span v-if="loading" class="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"></span>
                            <span v-else>CONFIRM PAYMENT</span>
                        </button>
                    </div>
                </div>
            </transition>

        </main>

        <!-- BOTTOM NAV -->
        <div class="fixed bottom-0 w-full bg-white border-t border-gray-200 z-50 pb-safe shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
            <div class="grid grid-cols-5 h-16 max-w-md mx-auto">
                <a href="index.html" class="nav-item"><i class="fa-solid fa-house"></i><span>Home</span></a>
                <a href="add-money.html" class="nav-item active"><i class="fa-solid fa-wallet"></i><span>Add Money</span></a>
                <a href="orders.html" class="nav-item"><i class="fa-solid fa-file-invoice"></i><span>My Orders</span></a>
                <a href="codes.html" class="nav-item"><i class="fa-solid fa-gift"></i><span>My Codes</span></a>
                <a href="account.html" class="nav-item"><i class="fa-solid fa-user"></i><span>Account</span></a>
            </div>
        </div>

    </div>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { createApp, ref, computed, onMounted } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";

        const firebaseConfig = {
          apiKey: "AIzaSyACUK207BRvtR5yc1UhYLS9FlMitVVlrrE",
          authDomain: "freetopup-fd263.firebaseapp.com",
          projectId: "freetopup-fd263",
          storageBucket: "freetopup-fd263.firebasestorage.app",
          messagingSenderId: "756173302110",
          appId: "1:756173302110:web:14227664f6b5d14d9047cf"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        createApp({
            setup() {
                const step = ref(1);
                const amount = ref('');
                const method = ref('');
                const senderNumber = ref('');
                const trxId = ref('');
                const loading = ref(false);
                const adminNumber = ref('Loading...');
                const allPaymentNumbers = ref({});
                
                const popup = ref({ show: false, type: '', title: '', msg: '', btnText: '' });
                const userId = localStorage.getItem('userId');
                if(!userId) window.location.href = 'login.html';

                const fetchPaymentSettings = async () => {
                    try {
                        const docRef = doc(db, "settings", "payment");
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            allPaymentNumbers.value = docSnap.data();
                        }
                    } catch (e) { console.error(e); }
                };

                const goToMethod = () => {
                    if(!amount.value || amount.value < 10) return showPopup('error', 'Invalid Amount', 'Min 10 BDT', 'Try Again');
                    step.value = 2;
                };

                const selectMethod = (m) => {
                    method.value = m;
                    adminNumber.value = allPaymentNumbers.value[m] || "Not Set";
                    step.value = 3;
                };

                const showPopup = (type, title, msg, btnText = "OK") => {
                    popup.value = { show: true, type, title, msg, btnText };
                };

                const closePopup = () => {
                    popup.value.show = false;
                    if(popup.value.type === 'success') window.location.href = "account.html";
                };

                const submitPayment = async () => {
                    if(!senderNumber.value || !trxId.value) return showPopup('error', 'Missing Info', 'Fill all fields.', 'Fix Now');
                    
                    loading.value = true;
                    try {
                        await addDoc(collection(db, "deposits"), {
                            userId, method: method.value, amount: Number(amount.value), 
                            senderNumber: senderNumber.value, trxId: trxId.value.toUpperCase(), 
                            status: "pending", createdAt: serverTimestamp()
                        });
                        showPopup('success', 'Submitted', 'Wait for approval.', 'Go to Account');
                    } catch (e) {
                        showPopup('error', 'Failed', 'Try again.', 'OK');
                    } finally {
                        loading.value = false;
                    }
                };

                const gatewayColor = computed(() => {
                    if(method.value === 'bkash') return 'bg-[#e2136e]';
                    if(method.value === 'nagad') return 'bg-[#ec1c24]';
                    return 'bg-[#8c3494]';
                });

                const gatewayButtonColor = computed(() => {
                    if(method.value === 'bkash') return 'bg-[#e2136e] hover:bg-[#c40f5f]';
                    if(method.value === 'nagad') return 'bg-[#ec1c24] hover:bg-[#cc161d]';
                    return 'bg-[#8c3494] hover:bg-[#722a79]';
                });

                const methodLogo = computed(() => {
                    if(method.value === 'bkash') return 'https://seeklogo.com/images/B/bkash-logo-FBB258B90F-seeklogo.com.png';
                    if(method.value === 'nagad') return 'https://seeklogo.com/images/N/nagad-logo-7A70CCFEE0-seeklogo.com.png';
                    return 'https://seeklogo.com/images/D/dutch-bangla-rocket-logo-B4D1CC458D-seeklogo.com.png';
                });

                const copyNumber = () => { navigator.clipboard.writeText(adminNumber.value); };

                onMounted(fetchPaymentSettings);

                return {
                    step, amount, method, senderNumber, trxId, loading, adminNumber,
                    goToMethod, selectMethod, gatewayColor, gatewayButtonColor, methodLogo, copyNumber, submitPayment, popup, closePopup
                };
            }
        }).mount('#app');
    </script>
</body>
</html>