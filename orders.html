<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Orders - FREE TOPUP PRO</title>
    
    <!-- CDNs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f0f5ff; }
        [v-cloak] { display: none !important; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Bottom Nav */
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; font-weight: 500; color: #64748b; text-decoration: none; transition: 0.3s; }
        .nav-item i { font-size: 18px; margin-bottom: 4px; }
        .nav-item.active { color: #583cb3; font-weight: 700; }

        /* Status Badges */
        .status-pending { background-color: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; }
        .status-completed { background-color: #f0fdf4; color: #15803d; border: 1px solid #dcfce7; }
        .status-cancelled { background-color: #fef2f2; color: #b91c1c; border: 1px solid #fee2e2; }

        /* Animation */
        .list-enter-active, .list-leave-active { transition: all 0.4s ease; }
        .list-enter-from, .list-leave-to { opacity: 0; transform: translateY(20px); }
    </style>
</head>
<body class="bg-[#f0f5ff]">

    <div id="app" v-cloak class="max-w-md mx-auto min-h-screen relative flex flex-col">
        
        <!-- Header -->
        <header class="bg-white shadow-sm border-b p-4 sticky top-0 z-40">
            <div class="flex justify-between items-center">
                <h1 class="font-bold text-xl text-gray-800">My Orders</h1>
                <div class="bg-purple-50 text-[#583cb3] px-3 py-1 rounded-full text-xs font-bold">
                    {{ filteredOrders.length }} Orders
                </div>
            </div>
            
            <!-- Filter Tabs -->
            <div class="flex gap-2 mt-4 overflow-x-auto no-scrollbar pb-1">
                <button @click="filter = 'all'" :class="filter === 'all' ? 'bg-[#583cb3] text-white' : 'bg-gray-100 text-gray-600'" class="px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition">All</button>
                <button @click="filter = 'pending'" :class="filter === 'pending' ? 'bg-[#583cb3] text-white' : 'bg-gray-100 text-gray-600'" class="px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition">Pending</button>
                <button @click="filter = 'completed'" :class="filter === 'completed' ? 'bg-[#583cb3] text-white' : 'bg-gray-100 text-gray-600'" class="px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition">Completed</button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow p-4 pb-24">
            
            <!-- Loading State -->
            <div v-if="loading" class="flex flex-col items-center justify-center h-64">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
                <p class="text-gray-400 text-xs mt-3">Loading orders...</p>
            </div>

            <!-- Empty State -->
            <div v-else-if="filteredOrders.length === 0" class="flex flex-col items-center justify-center h-80 text-center">
                <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4 text-gray-400">
                    <i class="fa-solid fa-box-open text-3xl"></i>
                </div>
                <h3 class="font-bold text-gray-700">No Orders Found</h3>
                <p class="text-xs text-gray-500 mt-1 mb-6">You haven't placed any orders yet.</p>
                <a href="index.html" class="bg-[#583cb3] text-white px-6 py-2.5 rounded-lg text-sm font-bold shadow-lg hover:bg-purple-700 transition">Order Now</a>
            </div>

            <!-- Order List -->
            <transition-group name="list" tag="div" class="space-y-3" v-else>
                <div v-for="order in filteredOrders" :key="order.id" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 relative overflow-hidden group">
                    
                    <!-- Decorative Line -->
                    <div class="absolute left-0 top-0 bottom-0 w-1" :class="getStatusColor(order.status)"></div>

                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] text-gray-400 font-mono">#{{ order.id.slice(-6).toUpperCase() }}</span>
                            <i @click="copyId(order.id)" class="fa-regular fa-copy text-[10px] text-gray-400 cursor-pointer hover:text-purple-600"></i>
                        </div>
                        <span :class="getStatusClass(order.status)" class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide">
                            {{ order.status }}
                        </span>
                    </div>

                    <div class="flex gap-3 items-center mb-3">
                        <div class="w-10 h-10 rounded-lg bg-purple-50 flex items-center justify-center text-purple-600 text-xl">
                            <i class="fa-solid fa-gem"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-sm leading-tight">{{ order.packageName }}</h3>
                            <p class="text-xs text-gray-500 mt-0.5">Player ID: <span class="font-mono font-bold text-gray-700">{{ order.playerId }}</span></p>
                        </div>
                    </div>

                    <div class="flex justify-between items-center border-t border-gray-100 pt-3">
                        <div class="text-[10px] text-gray-400 flex items-center gap-1">
                            <i class="fa-regular fa-clock"></i> {{ formatDate(order.createdAt) }}
                        </div>
                        <div class="text-sm font-black text-[#583cb3]">
                            ৳ {{ order.price }}
                        </div>
                    </div>

                </div>
            </transition-group>
            
        </main>

        <!-- Bottom Nav -->
        <div class="fixed bottom-0 w-full bg-white border-t border-gray-200 z-50 pb-safe shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
            <div class="grid grid-cols-5 h-16 max-w-md mx-auto">
                <a href="index.html" class="nav-item"><i class="fa-solid fa-house"></i><span>Home</span></a>
                <a href="add-money.html" class="nav-item"><i class="fa-solid fa-wallet"></i><span>Add Money</span></a>
                <a href="orders.html" class="nav-item active"><i class="fa-solid fa-file-invoice"></i><span>My Orders</span></a>
                <a href="codes.html" class="nav-item"><i class="fa-solid fa-gift"></i><span>My Codes</span></a>
                <a href="account.html" class="nav-item"><i class="fa-solid fa-user"></i><span>Account</span></a>
            </div>
        </div>

    </div>

    <!-- Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { createApp, ref, computed, onMounted } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";

        const firebaseConfig = {
          apiKey: "AIzaSyACUK207BRvtR5yc1UhYLS9FlMitVVlrrE",
          authDomain: "freetopup-fd263.firebaseapp.com",
          projectId: "freetopup-fd263",
          storageBucket: "freetopup-fd263.firebasestorage.app",
          messagingSenderId: "756173302110",
          appId: "1:756173302110:web:14227664f6b5d14d9047cf"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        createApp({
            setup() {
                const loading = ref(true);
                const orders = ref([]);
                const filter = ref('all');
                
                const userId = localStorage.getItem('userId');
                if(!userId) window.location.href = 'login.html';

                const fetchOrders = async () => {
                    try {
                        // Firebase Compound Query Constraint:
                        // 'orderBy' ব্যবহার করতে হলে ইনডেক্স লাগে। তাই আমরা ক্লায়েন্ট সাইডে সর্ট করব।
                        const q = query(collection(db, "orders"), where("userId", "==", userId));
                        const querySnapshot = await getDocs(q);
                        
                        let tempOrders = [];
                        querySnapshot.forEach((doc) => {
                            tempOrders.push({ id: doc.id, ...doc.data() });
                        });

                        // Sort by Date Descending (Newest First)
                        tempOrders.sort((a, b) => {
                            return (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
                        });

                        orders.value = tempOrders;
                    } catch (error) {
                        console.error("Error fetching orders:", error);
                    } finally {
                        loading.value = false;
                    }
                };

                const filteredOrders = computed(() => {
                    if (filter.value === 'all') return orders.value;
                    return orders.value.filter(order => order.status === filter.value);
                });

                const getStatusClass = (status) => {
                    if (status === 'completed') return 'status-completed';
                    if (status === 'cancelled') return 'status-cancelled';
                    return 'status-pending';
                };

                const getStatusColor = (status) => {
                    if (status === 'completed') return 'bg-green-500';
                    if (status === 'cancelled') return 'bg-red-500';
                    return 'bg-orange-400';
                };

                const formatDate = (timestamp) => {
                    if (!timestamp) return 'Just now';
                    const date = new Date(timestamp.seconds * 1000);
                    return date.toLocaleDateString('en-US', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
                };

                const copyId = (id) => {
                    navigator.clipboard.writeText(id);
                    alert("Order ID copied!");
                };

                onMounted(() => {
                    fetchOrders();
                });

                return {
                    loading, orders, filter, filteredOrders,
                    getStatusClass, getStatusColor, formatDate, copyId
                };
            }
        }).mount('#app');
    </script>
</body>
</html>