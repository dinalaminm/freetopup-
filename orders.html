<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Orders - FREE TOPUP PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body class="bg-[#f0f5ff]">

    <div id="app" v-cloak>
        <header class="bg-white shadow-sm border-b p-3 sticky top-0 z-50">
            <h1 class="font-bold text-lg text-center text-gray-800">My Orders</h1>
        </header>

        <main class="container mx-auto px-4 py-4 max-w-md pb-24">
            
            <div v-if="loading" class="text-center py-10">
                <i class="fa-solid fa-spinner fa-spin text-purple-600 text-2xl"></i>
            </div>

            <div v-else-if="orders.length === 0" class="flex flex-col items-center justify-center py-10 opacity-60">
                <i class="fa-solid fa-box-open text-4xl text-gray-400 mb-3"></i>
                <p>কোনো অর্ডার পাওয়া যায়নি।</p>
            </div>

            <div v-else class="space-y-3">
                <div v-for="order in orders" :key="order.id" class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex justify-between items-center relative overflow-hidden">
                    <!-- Status Indicator Line -->
                    <div :class="getStatusColor(order.status)" class="absolute left-0 top-0 bottom-0 w-1.5"></div>
                    
                    <div>
                        <h3 class="font-bold text-gray-800 text-sm">{{ order.packageName }}</h3>
                        <p class="text-xs text-gray-500 mt-0.5"><i class="fa-solid fa-gamepad"></i> {{ order.playerId }}</p>
                        <p class="text-[10px] text-gray-400 mt-1">{{ formatDate(order.createdAt) }}</p>
                    </div>
                    <div class="text-right">
                        <span :class="getStatusBadge(order.status)" class="text-[10px] font-bold px-2 py-0.5 rounded-full uppercase border">
                            {{ order.status }}
                        </span>
                        <p class="text-sm font-bold text-purple-600 mt-1">৳ {{ order.price }}</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Fixed Bottom Nav -->
        <div class="fixed bottom-0 w-full bg-white border-t border-gray-200 z-50 pb-safe shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
            <div class="grid grid-cols-5 h-16 max-w-md mx-auto">
                <a href="index.html" class="nav-item"><i class="fa-solid fa-house"></i><span>Home</span></a>
                <a href="add-money.html" class="nav-item"><i class="fa-solid fa-wallet"></i><span>Add Money</span></a>
                <a href="orders.html" class="nav-item active"><i class="fa-solid fa-file-invoice"></i><span>My Orders</span></a>
                <a href="codes.html" class="nav-item"><i class="fa-solid fa-gift"></i><span>My Codes</span></a>
                <a href="account.html" class="nav-item"><i class="fa-solid fa-user"></i><span>Account</span></a>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { createApp, ref, onMounted } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";

        const firebaseConfig = {
          apiKey: "AIzaSyACUK207BRvtR5yc1UhYLS9FlMitVVlrrE",
          authDomain: "freetopup-fd263.firebaseapp.com",
          projectId: "freetopup-fd263",
          storageBucket: "freetopup-fd263.firebasestorage.app",
          messagingSenderId: "756173302110",
          appId: "1:756173302110:web:14227664f6b5d14d9047cf"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        createApp({
            setup() {
                const loading = ref(true);
                const orders = ref([]);
                const userId = localStorage.getItem('userId') || 'guest';

                const fetchOrders = async () => {
                    try {
                        // Query: Select * from orders where userId == 'current_user'
                        const q = query(
                            collection(db, "orders"), 
                            where("userId", "==", userId)
                        );
                        
                        const querySnapshot = await getDocs(q);
                        const tempOrders = [];
                        
                        querySnapshot.forEach((doc) => {
                            tempOrders.push({ id: doc.id, ...doc.data() });
                        });

                        // Client side sorting (Newest first)
                        tempOrders.sort((a, b) => b.createdAt - a.createdAt);
                        orders.value = tempOrders;
                    } catch (error) {
                        console.error("Error fetching orders:", error);
                    } finally {
                        loading.value = false;
                    }
                };

                const getStatusColor = (status) => {
                    if(status === 'completed') return 'bg-green-500';
                    if(status === 'pending') return 'bg-yellow-500';
                    return 'bg-red-500';
                };

                const getStatusBadge = (status) => {
                    if(status === 'completed') return 'bg-green-50 text-green-600 border-green-200';
                    if(status === 'pending') return 'bg-yellow-50 text-yellow-600 border-yellow-200';
                    return 'bg-red-50 text-red-600 border-red-200';
                };

                const formatDate = (timestamp) => {
                    if (!timestamp) return '';
                    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                    return date.toLocaleDateString("en-US", { month: 'short', day: 'numeric', hour: '2-digit', minute:'2-digit' });
                };

                onMounted(fetchOrders);

                return { loading, orders, getStatusColor, getStatusBadge, formatDate };
            }
        }).mount('#app');
    </script>
</body>
</html>